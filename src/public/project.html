<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <title>深度传媒</title>
    <link rel="stylesheet" href="css/lib/font-awesome.css" />
    <script type="text/javascript" src="js/lib/jquery.js"></script>
    <script type="text/javascript" src="js/jquery.mixitup.js"></script>
    <link rel="stylesheet" href="css/slicknav.css" />
    <link rel="stylesheet" href="css/navbar.css" />
    <link rel="stylesheet" href="css/reset.css">
    <link rel="stylesheet" href="css/form.css" />
    <script src="js/vertical-timeline.js"></script>
    <link rel="stylesheet" type="text/css" href="css/vertical-timeline.css">
    <script src="js/jquery.barrating.min.js"></script>
    <link rel="stylesheet" href="css/bars-movie.css">
    <style>
        .page-title {
            padding: 10px 5px;
            margin: 20px 10px;
            border-bottom: 1px solid rgba(230, 230, 230, 1);
        }
        .page-title-main {
            font-size: 18px;
        }
        .page-title-eng {
            font-size: 12px;
            color: rgba(150, 150, 150, 1);
        }
        
        .project {
            background-color: rgba(255, 255, 255, 1);
            width: calc(100% - 30px);
            padding: 15px;
            border-bottom: 1px solid rgba(230, 230, 230, 1);
            display: flex;
        }
        
        .project-img {
            width: 80px;
            height: 60px;
        }
        
        .project-info {
            
        }
    </style>
</head>
<body>
    <nav id="navbar">
        <div id="navbar-left">
            <a href="branding.html">案例展示</a>
            <a href="news.html">最新动态</a>
        </div>
        <div id="navbar-middle">
            <img src="img/logo-sm.png" />
        </div>
        <div id="navbar-right">
            <a href="about.html">关于我们</a>
            <a href="join.html" class="active">加入我们</a>
        </div>
    </nav>
    <main>
        <div class="page-title">
            <div class="page-title-main">您的项目</div>
            <div class="page-title-eng">Project</div>
        </div>
        <div>
            <ul id="projects">
                <!-- -->
            </ul>
        </div>
    </main>
    <script type="text/javascript">
        var ProjectPage = {
            params: undefined,
            accessToken: undefined,
            openId: undefined,
            UUID: "3a4f1056-d6e7-11e6-a123-00163e18ffbf",
            initiate: function () {
                var self = this;
                this.initiateParams(function () {
                    self.initiateAccessToken(function () {
                        self.initiateUUID(function () {
                            self.initiateProject();
                        });
                    });
                });
            },
            initiateParams: function (callback) {
                this.params = Utility.getQueryParams();
                if (this.params["code"]) {
                    callback();
                }
                else {
                    this.redirectProject();
                }
            },
            initiateAccessToken: function (callback) {
                var self = this;
                $.ajax({
                    url: "/ajax/wechat_client?action=grant_credential",
                    type: "post",
                    data: {
                        code: this.params["code"]
                    },
                    success: function (result) {
                        var data = JSON.parse(result);
                        if (data["error_code"] == 0) {
                            var content = data["content"];
                            self.accessToken = content["access_token"];
                            self.openId = content["openid"];
                            callback();
                        }
                        else {
                            alert("Error " + data["error_code"] + ": " + data["error_log"]);
                            window.location.href = "404.html";
                        }
                    },
                    error: function () {
                        alert("服务器连接错误，请稍后再试");
                        window.location.href = "404.html";
                    }
                });
            },
            initiateUUID: function (callback) {
                var self = this;
                $.ajax({
                    url: "/ajax/wechat_client?action=get_uuid",
                    type: "post",
                    data: {
                        "open_id": this.openId
                    },
                    success: function (result) {
                        var data = JSON.parse(result);
                        if (data["error_code"] == 0) {
                            self.UUID = data["content"]["UUID"];
                            callback();
                        }
                        else {
                            alert("Error " + data["error_code"] + ": " + data["error_log"]);
                            window.location.href = "404.html";
                        }
                    },
                    error: function () {
                        alert("服务器连接错误，请稍后再试");
                        window.location.href = "404.html";
                    }
                });
            },
            initiateProject: function () {
                var self = this;
                $.ajax({
                    url: "/ajax/wechat_client?action=get_client_project",
                    type: "post",
                    data: {
                        "UUID": this.UUID
                    },
                    success: function (result) {
                        var data = JSON.parse(result);
                        if (data["error_code"] == 0) {
                            self.render(data["content"])
                        }
                        else {
                            alert("Error " + data["error_code"] + ": " + data["error_log"]);
                            window.location.href = "404.html";
                        }
                    },
                    error: function () {
                        alert("服务器连接错误，请稍后再试");
                        window.location.href = "404.html";
                    }
                })
            },
            render: function (projects) {
                var html = 0;
                for (var i = 0; i < projects.length; i++) {
                    html += "<li class=\"project\">"
                        + "<a href=\"progress.html?p=" + projects[i]["PUID"] + "\">"
                            + "<div class=\"project-info\">"
                                + "<div class=\"project-title\">" + projects[i]["title"] + "</div>"
                                + "<div class=\"project-description\">" + projects[i]["description"] + "</div>"
                                + "<div class=\"project-date-time\">" + projects[i]["date_time"] + "</div>"
                            + "</div>"
                            + "<div class=\"project-status\">" + projects[i]["status"] + "</div>"
                        + "</a>"
                    + "</li>";
                }
                $("#projects").html(html);
            },
            redirectProject: function () {
                $.ajax({
                    url: "/ajax/wechat_client?action=get_project_uri",
                    type: "get",
                    success: function (result) {
                        var data = JSON.parse(result);
                        if (data["error_log"] == 0) {
                            window.location.href = data["content"]["uri"];
                        }
                        else {
                            alert("Error " + data["error_code"] + ": " + data["error_log"]);
                        }
                    },
                    error: function () {
                        alert("服务器连接错误");
                    }
                });
            }
        }
        
        $(function () {
            ProjectPage.initiate();
        });
    </script>
</body>
</html>
